<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>이벤트 상세</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#f8f1e7] min-h-screen p-6 text-gray-800">
  <div class="max-w-4xl mx-auto bg-white rounded-3xl shadow-lg p-8 space-y-10" id="eventContainer"></div>

  <script>
    const eventId = new URLSearchParams(location.search).get("id");
    const userId = sessionStorage.getItem("userId");

    if (!userId) {
      alert("로그인이 필요합니다.");
      location.href = "/login.html";
    }

    async function getCsrfToken() {
      const res = await fetch('/api/auth/csrf-token', { credentials: 'same-origin' });
      const data = await res.json();
      return data.token;
    }

    async function renderEvent() {
      const res = await fetch(`/api/events/${eventId}`);
      const result = await res.json();
      const event = result?.eventDto;

      if (!event) {
        document.getElementById("eventContainer").innerHTML = `
          <div class="text-red-500 font-semibold">이벤트 정보를 불러오지 못했습니다.</div>`;
        return;
      }

      const container = document.getElementById("eventContainer");
      container.innerHTML = `
        <div class="flex justify-between items-center">
          <h1 class="text-3xl font-bold">${event.title}</h1>
          <button onclick="location.href='/events/invite?id=${event.eventId}'" class="bg-[#7c6dfa] text-white px-4 py-2 rounded-full text-sm">사용자 초대</button>
        </div>
        <div>
          <h2 class="text-lg font-semibold mb-2">참여자 ID</h2>
          <ul class="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm text-gray-600">
            ${event.userIds.map(id => `<li class="bg-[#f3f0ea] px-4 py-2 rounded-xl">사용자 ${id}</li>`).join('')}
          </ul>
        </div>
        <div>
          <h2 class="text-lg font-semibold mb-2">이벤트 날짜</h2>
          <ul class="flex flex-wrap gap-2 text-sm text-gray-600">
            ${event.eventDates.map(d => `<li class="bg-[#fcf8f3] px-4 py-2 rounded-full">${d}</li>`).join('')}
          </ul>
        </div>
        <div class="flex justify-between items-center">
          <div class="space-x-2">
            <button onclick="editEvent('${event.eventId}', '${event.title}', ${JSON.stringify(event.eventDates)})"
                    class="bg-yellow-400 hover:bg-yellow-300 text-white px-4 py-2 rounded-full">이벤트 수정</button>
            <button onclick="deleteEvent('${event.eventId}')" 
                    class="bg-red-400 hover:bg-red-300 text-white px-4 py-2 rounded-full">이벤트 삭제</button>
          </div>
          <button onclick="location.href='/schedule/create?eventId=${event.eventId}'"
                  class="bg-[#7c6dfa] text-white px-6 py-2 rounded-full">스케줄 생성</button>
        </div>`;
    }

    async function deleteEvent(eventId) {
      const csrf = await getCsrfToken();
      const formData = new URLSearchParams();
      formData.append("userId", userId);
      formData.append("eventId", eventId);
      formData.append("_csrf", csrf);

      const res = await fetch("/api/events", {
        method: "DELETE",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: formData
      });

      const result = await res.json();
      if (result.result === "success") {
        alert("삭제되었습니다.");
        location.href = "/";
      } else {
        alert("삭제 실패: " + JSON.stringify(result));
      }
    }

    async function editEvent(eventId, title, dates) {
      const newDate = prompt("추가할 날짜를 입력하세요 (예: 2025-05-31)");
      if (!newDate) return;

      const csrf = await getCsrfToken();
      const formData = new URLSearchParams();
      formData.append("userId", userId);
      formData.append("eventId", eventId);
      formData.append("title", title);
      [...dates, newDate].forEach(d => formData.append("eventDates", d));
      formData.append("_csrf", csrf);

      const res = await fetch("/api/events", {
        method: "PUT",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: formData
      });

      const result = await res.json();
      if (result.result === "success") {
        alert("수정되었습니다.");
        renderEvent();
      } else {
        alert("수정 실패: " + JSON.stringify(result));
      }
    }

    renderEvent();
  </script>
</body>
</html>
