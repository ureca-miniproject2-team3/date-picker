<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>이벤트 상세</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .time-slot {
            height: 60px;
            margin: 8px 0;
            border-radius: 6px;
            display: flex;
            align-items: center;
            padding: 0 12px;
            font-size: 14px;
            position: relative;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .time-slot:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .time-slot-bg {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            z-index: 1;
        }

        .time-slot-content {
            position: relative;
            z-index: 2;
            display: flex;
            width: 100%;
            justify-content: space-between;
        }

        .user-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-right: 4px;
            margin-bottom: 4px;
            background-color: #e9e4f8;
            color: #5a4db8;
        }

        .schedule-card {
            transition: all 0.2s ease;
        }

        .schedule-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
        }

        /* Calendar styles */
        .selected { 
            background-color: #7c6dfa !important; 
            color: white !important; 
        }

        .existing-date {
            background-color: #e0e0e0 !important;
            color: #333 !important;
            cursor: not-allowed !important;
        }

        .date-disabled { 
            opacity: 0.3; 
            cursor: not-allowed !important; 
            pointer-events: none; 
        }

        .btn-transition { 
            transition: all 0.2s ease; 
        }
    </style>
</head>
<body class="bg-[#f8f1e7] min-h-screen p-6 text-gray-800">
<div class="max-w-4xl mx-auto bg-white rounded-3xl shadow-lg p-8 space-y-8" id="eventContainer"></div>

<!-- User Invitation Modal -->
<div id="inviteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-md">
        <h2 class="text-xl font-bold mb-4">사용자 초대</h2>
        <div class="mb-4">
            <input type="email" id="searchEmail" placeholder="이메일로 검색"
                   class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#7c6dfa]">
        </div>
        <div id="searchResults" class="mb-4 max-h-60 overflow-y-auto"></div>
        <div class="flex justify-end space-x-2">
            <button onclick="closeInviteModal()" class="px-4 py-2 bg-gray-200 rounded-lg">취소</button>
        </div>
    </div>
</div>

<!-- Event Edit Modal -->
<div id="editEventModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-lg">
        <h2 class="text-xl font-bold mb-4">이벤트 수정</h2>
        <div class="mb-4">
            <label for="editEventTitle" class="block font-bold text-gray-800 mb-2">이벤트 제목</label>
            <input type="text" id="editEventTitle" placeholder="이벤트 제목을 입력하세요"
                   class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#7c6dfa]">
        </div>

        <div class="mb-4">
            <label class="block font-bold text-gray-800 mb-2">날짜 선택</label>
            <div class="bg-[#fcf8f3] rounded-2xl p-4 shadow-sm">
                <div class="flex justify-between items-center mb-4">
                    <button id="editPrevMonth" class="text-gray-500 hover:text-gray-800 btn-transition">&#9664;</button>
                    <div class="text-gray-800 font-semibold text-lg" id="edit-calendar-title">2025.05</div>
                    <button id="editNextMonth" class="text-gray-500 hover:text-gray-800 btn-transition">&#9654;</button>
                </div>

                <div class="grid grid-cols-7 text-center text-sm font-medium text-gray-500 mb-2">
                    <div class="text-red-400">일</div>
                    <div>월</div>
                    <div>화</div>
                    <div>수</div>
                    <div>목</div>
                    <div>금</div>
                    <div class="text-blue-400">토</div>
                </div>

                <div id="edit-calendar" class="grid grid-cols-7 gap-1 text-center text-gray-700"></div>
            </div>

            <div class="mt-4 text-sm text-gray-500">
                <span class="inline-block w-3 h-3 bg-[#7c6dfa] rounded-full mr-1"></span> 선택된 날짜
                <span class="inline-block ml-3 w-3 h-3 bg-[#e0e0e0] rounded-full mr-1"></span> 기존 날짜 (해제 불가)
                <span class="inline-block ml-3 opacity-30">&#9679;</span> 선택 불가능한 날짜
            </div>
        </div>

        <div class="flex justify-end space-x-2">
            <button onclick="closeEditEventModal()" class="px-4 py-2 bg-gray-200 rounded-lg">취소</button>
            <button id="saveEventBtn" class="px-4 py-2 bg-[#7c6dfa] text-white rounded-lg">저장</button>
        </div>
    </div>
</div>

<script>
    const eventId = new URLSearchParams(location.search).get("id");
    const userId = sessionStorage.getItem("userId");

    if (!userId) {
        alert("로그인이 필요합니다.");
        location.href = "/login.html";
    }

    if (!eventId) {
        alert("이벤트 ID가 필요합니다.");
        location.href = "/";
    }

    async function getCsrfToken() {
        const res = await fetch('/api/auth/csrf-token', {credentials: 'same-origin'});
        const data = await res.json();
        return data.token;
    }

    async function renderEvent() {
        try {
            // 이벤트 정보 가져오기
            const eventRes = await fetch(`/api/events/${eventId}`);
            const eventResult = await eventRes.json();
            const event = eventResult?.eventDto;

            if (!event) {
                document.getElementById("eventContainer").innerHTML = `
            <div class="text-red-500 font-semibold">이벤트 정보를 불러오지 못했습니다.</div>`;
                return;
            }

            // 스케줄 정보 가져오기
            const scheduleRes = await fetch(`/api/event/${eventId}/schedules`);
            const scheduleResult = await scheduleRes.json();
            const schedules = scheduleResult?.scheduleDtoList || [];

            // 가장 많이 겹치는 시간대 가져오기
            const overlapRes = await fetch(`/api/schedules/overlap/${eventId}`);
            const overlapResult = await overlapRes.json();
            const timeSlots = overlapResult?.timeSlots || [];
            const maxCount = overlapResult?.maxCount || 0;

            // Sort timeSlots by number of participants (descending) and then by date/time (ascending)
            timeSlots.sort((a, b) => {
                // First sort by number of participants (descending)
                if (b.userIds.length !== a.userIds.length) {
                    return b.userIds.length - a.userIds.length;
                }
                // Then sort by date/time (ascending)
                return new Date(a.start) - new Date(b.start);
            });

            // 사용자 정보 매핑을 위한 Map 생성
            const userMap = {};

            // 모든 사용자 정보 가져오기
            try {
                const usersRes = await fetch(`/api/users`);
                const usersResult = await usersRes.json();
                const users = usersResult?.userDtoList || [];

                // 사용자 ID를 키로, 이름을 값으로 하는 맵 생성
                users.forEach(user => {
                    userMap[user.id] = user.name || `사용자 ${user.id}`;
                });
            } catch (error) {
                console.error('Error fetching users:', error);
                // 오류 발생 시 기본값으로 설정
                event.userIds.forEach(id => {
                    userMap[id] = `사용자 ${id}`;
                });
            }

            const container = document.getElementById("eventContainer");
            container.innerHTML = `
          <div class="flex justify-between items-center border-b pb-5">
            <h1 class="text-3xl font-bold">${event.title}</h1>
            ${userId == event.ownerId ? `
            <button onclick="showInviteModal()" class="bg-[#7c6dfa] hover:bg-[#6a5cd6] text-white px-4 py-2 rounded-full text-sm flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
              사용자 초대
            </button>
            ` : ''}
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h2 class="text-lg font-semibold mb-3 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 text-[#7c6dfa]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                참여자 (${event.userIds.length}명)
              </h2>
              <div class="flex flex-wrap gap-2">
                ${event.userIds.map(id => {
                  const userName = userMap[id] || `사용자 ${id}`;
                  const initial = userName.charAt(0);
                  return `
                  <div class="bg-[#f3f0ea] px-3 py-1.5 rounded-xl text-sm flex items-center">
                    <span class="w-6 h-6 rounded-full bg-[#7c6dfa] text-white flex items-center justify-center text-xs mr-2">
                      ${initial}
                    </span>
                    ${userName}
                  </div>
                `;
                }).join('')}
              </div>
            </div>

            <div>
              <h2 class="text-lg font-semibold mb-3 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 text-[#7c6dfa]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                이벤트 날짜
              </h2>
              <div class="flex flex-wrap gap-2">
                ${event.eventDates.map(d => {
                const date = new Date(d);
                const options = {weekday: 'short', month: 'short', day: 'numeric'};
                const formattedDate = date.toLocaleDateString('ko-KR', options);
                return `
                    <div class="bg-[#fcf8f3] px-3 py-1.5 rounded-full text-sm flex items-center">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-[#7c6dfa]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                      </svg>
                      ${formattedDate}
                    </div>
                  `;
            }).join('')}
              </div>
            </div>
          </div>

          <!-- 가장 많이 겹치는 시간대 -->
          <div class="bg-white border border-gray-100 rounded-xl shadow-sm p-5 mt-4">
            <h2 class="text-lg font-semibold mb-4 flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 text-[#7c6dfa]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
              </svg>
              가장 많은 인원이 가능한 시간
              <span class="text-[#7c6dfa] font-bold ml-1">(최대 ${maxCount}명)</span>
            </h2>

            ${timeSlots.length > 0
                ? `<div class="bg-[#f8f8f8] p-4 rounded-xl mb-4">
                  <canvas id="timeSlotChart" class="w-full h-48 mb-4"></canvas>
                </div>
                <div class="space-y-2">
                  ${timeSlots.map((slot, index) => {
                    const startTime = new Date(slot.start);
                    const endTime = new Date(slot.end);

                    const formatTimeOnly = (date) => {
                        return date.toLocaleTimeString('ko-KR', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    };

                    const formatDateWithDay = (date) => {
                        return date.toLocaleDateString('ko-KR', {
                            month: 'long',
                            day: 'numeric',
                            weekday: 'short'
                        });
                    };

                    const percentage = (slot.userIds.length / maxCount) * 100;
                    const isBestTime = slot.userIds.length === maxCount;

                    return `
                      <div class="time-slot ${isBestTime ? 'border-2 border-[#7c6dfa] shadow-md' : 'border border-gray-100'} bg-white rounded-lg overflow-hidden ${isBestTime ? 'transform hover:scale-102' : ''}" style="height: ${isBestTime ? '76px' : '60px'}">
                        <div class="time-slot-bg" style="background-color: ${isBestTime ? '#e0dbff' : '#e8e4ff'}; width: ${percentage}%"></div>
                        <div class="time-slot-content">
                          <div>
                            <div class="font-medium ${isBestTime ? 'text-[#7c6dfa] text-base leading-normal' : 'leading-normal'}">
                              ${formatDateWithDay(startTime)} ${formatTimeOnly(startTime)} ~ ${formatTimeOnly(endTime)}
                              ${isBestTime ? '<span class="ml-2 text-xs bg-[#7c6dfa] text-white px-2 py-0.5 rounded-full font-bold">BEST</span>' : ''}
                            </div>
                            <div class="text-xs text-gray-500 mt-1.5 flex flex-wrap leading-relaxed">
                              ${slot.userIds.map(uid => `
                                <span class="user-badge">${userMap[uid] || `사용자 ${uid}`}</span>
                              `).join('')}
                            </div>
                          </div>
                          <div class="user-count text-lg font-bold ${isBestTime ? 'text-[#7c6dfa]' : 'text-gray-600'}">
                            ${slot.userIds.length}명
                          </div>
                        </div>
                      </div>`;
                }).join('')}
                </div>`
                : '<div class="text-gray-500 py-8 text-center">등록된 스케줄이 없습니다.</div>'
            }
          </div>

          <!-- 스케줄 캘린더 뷰 -->
          <div class="bg-white border border-gray-100 rounded-xl shadow-sm p-5 mt-4">
            <h2 class="text-lg font-semibold mb-4 flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 text-[#7c6dfa]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              등록된 스케줄
            </h2>

            ${schedules.length > 0
                ? `<div class="overflow-x-auto">
                    ${(() => {
                        // Group schedules by date
                        const schedulesByDate = {};
                        schedules.forEach(schedule => {
                            const startTime = new Date(schedule.startTime);
                            const dateStr = startTime.toLocaleDateString('ko-KR', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            });

                            if (!schedulesByDate[dateStr]) {
                                schedulesByDate[dateStr] = [];
                            }
                            schedulesByDate[dateStr].push(schedule);
                        });

                        // Sort dates
                        const sortedDates = Object.keys(schedulesByDate).sort((a, b) => {
                            return new Date(a) - new Date(b);
                        });

                        return `
                            <div class="space-y-6">
                                ${sortedDates.map(dateStr => {
                                    const dateSchedules = schedulesByDate[dateStr];

                                    return `
                                        <div class="border rounded-lg overflow-hidden">
                                            <div class="bg-[#f0efff] px-4 py-3 font-medium text-[#7c6dfa]">
                                                ${dateStr}
                                            </div>
                                            <div class="divide-y">
                                                ${dateSchedules.map(schedule => {
                                                    const startTime = new Date(schedule.startTime);
                                                    const endTime = new Date(schedule.endTime);

                                                    const formatTimeOnly = (date) => {
                                                        return date.toLocaleTimeString('ko-KR', {
                                                            hour: '2-digit',
                                                            minute: '2-digit'
                                                        });
                                                    };

                                                    const isCurrentUser = schedule.userId === userId;

                                                    return `
                                                        <div class="px-4 py-3 flex items-center justify-between ${isCurrentUser ? 'bg-[#fafafa]' : ''}">
                                                            <div class="flex items-center">
                                                                <div class="w-10 text-center text-sm text-gray-500">
                                                                    ${formatTimeOnly(startTime)}
                                                                </div>
                                                                <div class="ml-4 flex items-center">
                                                                    <span class="w-6 h-6 rounded-full ${isCurrentUser ? 'bg-[#7c6dfa]' : 'bg-gray-200'} text-${isCurrentUser ? 'white' : 'gray-700'} flex items-center justify-center text-xs mr-2">
                                                                        ${(userMap[schedule.userId] || `사용자 ${schedule.userId}`).charAt(0)}
                                                                    </span>
                                                                    <span class="font-medium">${userMap[schedule.userId] || `사용자 ${schedule.userId}`}</span>
                                                                    ${isCurrentUser ? '<span class="ml-2 text-xs bg-[#7c6dfa] text-white px-2 py-0.5 rounded-full">나</span>' : ''}
                                                                </div>
                                                            </div>
                                                            <div class="text-sm text-gray-500">
                                                                ${formatTimeOnly(startTime)} ~ ${formatTimeOnly(endTime)}
                                                            </div>
                                                        </div>
                                                    `;
                                                }).join('')}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `;
                    })()}
                  </div>`
                : '<div class="text-gray-500 py-8 text-center">등록된 스케줄이 없습니다.</div>'
            }
          </div>

          <div class="flex justify-between items-center mt-8">
            <div class="space-x-4 flex">
              ${userId == event.ownerId ? `
              <button onclick="editEvent('${event.eventId}', '${event.title}', ${event.eventId})"
                      data-dates='${JSON.stringify(event.eventDates)}'
                      class="bg-yellow-400 hover:bg-yellow-300 text-white px-5 py-2.5 rounded-full flex items-center shadow-sm transition duration-200 ease-in-out hover:shadow">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
                <span class="leading-normal">이벤트 수정</span>
              </button>
              <button onclick="deleteEvent('${event.eventId}')"
                      class="bg-red-400 hover:bg-red-300 text-white px-5 py-2.5 rounded-full flex items-center shadow-sm transition duration-200 ease-in-out hover:shadow">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                <span class="leading-normal">이벤트 삭제</span>
              </button>
              ` : ''}
            </div>
            <button onclick="location.href='/schedule/create?eventId=${event.eventId}'"
                    class="bg-[#7c6dfa] hover:bg-[#6a5cd6] text-white px-5 py-2.5 rounded-full flex items-center shadow-sm transition duration-200 ease-in-out hover:shadow">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span class="leading-normal">스케줄 생성</span>
            </button>
          </div>`;

            // 시간대 차트 렌더링
            if (timeSlots.length > 0) {
                renderTimeSlotChart(timeSlots, maxCount);
            }
        } catch (error) {
            console.error('Error rendering event:', error);
            document.getElementById("eventContainer").innerHTML = `
          <div class="text-red-500 font-semibold">이벤트 정보를 불러오는 중 오류가 발생했습니다.</div>`;
        }
    }

    function renderTimeSlotChart(timeSlots, maxCount) {
        const ctx = document.getElementById('timeSlotChart').getContext('2d');

        const labels = timeSlots.map(slot => {
            const start = new Date(slot.start);
            return `${start.getHours().toString().padStart(2, '0')}:${start.getMinutes().toString().padStart(2, '0')}`;
        });

        const data = timeSlots.map(slot => slot.userIds.length);

        // 최대 인원수에 해당하는 데이터 포인트 색상을 강조
        const backgroundColors = data.map(value =>
            value === maxCount ? '#7c6dfa' : '#b6adfa'
        );

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: '참여 가능 인원',
                    data: data,
                    backgroundColor: backgroundColors,
                    borderColor: backgroundColors.map(color => color === '#7c6dfa' ? '#6a5adb' : '#9e95e8'),
                    borderWidth: 1,
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                const slotIndex = context.dataIndex;
                                const slot = timeSlots[slotIndex];
                                return `${slot.userIds.length}명 참여 가능`;
                            },
                            afterLabel: function (context) {
                                const slotIndex = context.dataIndex;
                                const slot = timeSlots[slotIndex];
                                return slot.userIds.map(id => userMap[id] || `사용자 ${id}`);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: maxCount + 1,
                        ticks: {
                            stepSize: 1,
                            font: {
                                size: 12
                            }
                        },
                        title: {
                            display: true,
                            text: '참여 가능 인원 수',
                            font: {
                                size: 14
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: '시간',
                            font: {
                                size: 14
                            }
                        }
                    }
                }
            }
        });
    }

    async function deleteSchedule(scheduleId) {
        if (!confirm('이 스케줄을 삭제하시겠습니까?')) return;

        try {
            const csrf = await getCsrfToken();
            const res = await fetch(`/api/schedules/${scheduleId}?userId=${userId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRF-TOKEN': csrf
                }
            });

            const result = await res.json();
            if (result.result === 'success') {
                alert('스케줄이 삭제되었습니다.');
                await renderEvent();
            } else {
                alert('스케줄 삭제에 실패했습니다.');
            }
        } catch (error) {
            console.error('Error deleting schedule:', error);
            alert('스케줄 삭제 중 오류가 발생했습니다.');
        }
    }

    async function deleteEvent(eventId) {
        if (!confirm('이 이벤트를 삭제하시겠습니까?')) return;

        try {
            const csrf = await getCsrfToken();
            const formData = new URLSearchParams();
            formData.append("userId", userId);
            formData.append("_csrf", csrf);

            const res = await fetch(`/api/events/${eventId}?userId=${userId}`, {
                method: "DELETE",
                headers: {"Content-Type": "application/x-www-form-urlencoded"},
                body: formData
            });

            const result = await res.json();
            if (result.result === "success") {
                alert("삭제되었습니다.");
                location.href = "/";
            } else {
                alert("삭제 실패: " + JSON.stringify(result));
            }
        } catch (error) {
            console.error('Error deleting event:', error);
            alert('이벤트 삭제 중 오류가 발생했습니다.');
        }
    }

    // 이벤트 수정 모달 관련 변수
    let editEventId = null;
    let existingDates = new Set();
    let selectedNewDates = new Set();
    let editCurrentYear = 2025;
    let editCurrentMonth = 5;

    // 오늘 날짜 계산
    const editToday = new Date();
    const editTodayYear = editToday.getFullYear();
    const editTodayMonth = editToday.getMonth() + 1;
    const editTodayDate = editToday.getDate();

    // 이벤트 수정 모달 열기
    async function editEvent(eventId, currentTitle, eventIdForDates) {
        // 모달 상태 초기화
        editEventId = eventId;
        existingDates = new Set();
        selectedNewDates = new Set();

        // 현재 날짜로 달력 초기화
        editCurrentYear = editTodayYear;
        editCurrentMonth = editTodayMonth;

        // 기존 날짜 가져오기
        const editButton = document.querySelector(`button[data-dates][onclick*="'${eventId}'"]`);
        const dates = JSON.parse(editButton.getAttribute('data-dates'));

        // 기존 날짜 설정
        dates.forEach(date => existingDates.add(date));

        // 제목 설정
        document.getElementById('editEventTitle').value = currentTitle;

        // 달력 생성
        generateEditCalendar(editCurrentYear, editCurrentMonth);

        // 모달 표시
        document.getElementById('editEventModal').classList.remove('hidden');
    }

    // 이벤트 수정 모달 닫기
    function closeEditEventModal() {
        document.getElementById('editEventModal').classList.add('hidden');
    }

    // 이벤트 수정 달력 생성
    function generateEditCalendar(year, month) {
        const calendar = document.getElementById("edit-calendar");
        calendar.innerHTML = "";
        const firstDay = new Date(year, month - 1, 1);
        const lastDay = new Date(year, month, 0);
        const startWeekday = firstDay.getDay();
        const totalDays = lastDay.getDate();

        // 달력 시작 전 빈 칸 추가
        for (let i = 0; i < startWeekday; i++) calendar.appendChild(document.createElement("div"));

        // 날짜 버튼 생성
        for (let day = 1; day <= totalDays; day++) {
            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const btn = document.createElement("button");
            btn.textContent = day;
            btn.dataset.date = dateStr;
            btn.className = "date-btn py-2 rounded-full hover:bg-[#e5dbff] cursor-pointer btn-transition";

            // 과거 날짜 비활성화
            const isPast = year < editTodayYear || 
                          (year === editTodayYear && month < editTodayMonth) || 
                          (year === editTodayYear && month === editTodayMonth && day < editTodayDate);

            if (isPast) {
                btn.classList.add("date-disabled");
            } else {
                // 기존 날짜는 선택 해제 불가능하게 설정
                if (existingDates.has(dateStr)) {
                    btn.classList.add("existing-date");
                } 
                // 새로 선택한 날짜 표시
                else if (selectedNewDates.has(dateStr)) {
                    btn.classList.add("selected");
                }

                // 클릭 이벤트 추가
                btn.addEventListener("click", () => {
                    // 기존 날짜는 선택 해제 불가능
                    if (existingDates.has(dateStr)) {
                        return;
                    }

                    // 새로 선택한 날짜 토글
                    if (selectedNewDates.has(dateStr)) {
                        selectedNewDates.delete(dateStr);
                        btn.classList.remove("selected");
                    } else {
                        selectedNewDates.add(dateStr);
                        btn.classList.add("selected");
                    }
                });
            }

            calendar.appendChild(btn);
        }

        // 달력 제목 업데이트
        document.getElementById("edit-calendar-title").textContent = `${year}.${String(month).padStart(2, '0')}`;
    }

    // 이벤트 수정 저장
    async function saveEditEvent() {
        const newTitle = document.getElementById('editEventTitle').value.trim();
        if (!newTitle) {
            alert("제목을 입력해주세요.");
            return;
        }

        // 모든 날짜 (기존 날짜 + 새로 선택한 날짜)
        const allDates = [...existingDates, ...selectedNewDates];

        try {
            const csrf = await getCsrfToken();
            const formData = new URLSearchParams();
            formData.append("userId", userId);
            formData.append("eventId", editEventId);
            formData.append("title", newTitle);
            allDates.forEach(d => formData.append("eventDates", d));
            formData.append("_csrf", csrf);

            const res = await fetch("/api/events", {
                method: "PUT",
                headers: {"Content-Type": "application/x-www-form-urlencoded"},
                body: formData
            });

            const result = await res.json();
            if (result.result === "success") {
                alert("수정되었습니다.");
                closeEditEventModal();
                await renderEvent();
            } else {
                alert("수정 실패: " + JSON.stringify(result));
            }
        } catch (error) {
            console.error('Error editing event:', error);
            alert('이벤트 수정 중 오류가 발생했습니다.');
        }
    }

    function showInviteModal() {
        document.getElementById('inviteModal').classList.remove('hidden');
        document.getElementById('searchEmail').focus();
        document.getElementById('searchEmail').addEventListener('input', searchUsers);
    }

    function closeInviteModal() {
        document.getElementById('inviteModal').classList.add('hidden');
        document.getElementById('searchEmail').removeEventListener('input', searchUsers);
    }

    async function searchUsers(e) {
        const email = e.target.value.trim();
        if (email.length < 3) {
            document.getElementById('searchResults').innerHTML = '';
            return;
        }

        try {
            const res = await fetch(`/api/users/search?email=${encodeURIComponent(email)}`);
            const result = await res.json();
            const user = result.userDto;

            const resultsContainer = document.getElementById('searchResults');
            if (!user) {
                resultsContainer.innerHTML = '<div class="text-gray-500 p-2">검색 결과가 없습니다.</div>';
                return;
            }

            resultsContainer.innerHTML = `
          <div class="p-3 border-b hover:bg-gray-50 flex justify-between items-center">
            <div>
              <div class="font-medium">${user.email}</div>
              <div class="text-sm text-gray-500">이름: ${user.name}</div>
            </div>
            <button onclick="inviteUser(${user.id})"
                    class="bg-[#7c6dfa] text-white px-3 py-1 rounded-lg text-sm">
              초대
            </button>
          </div>
        `;
        } catch (error) {
            console.error('Error searching users:', error);
            document.getElementById('searchResults').innerHTML =
                '<div class="text-red-500 p-2">사용자 검색 중 오류가 발생했습니다.</div>';
        }
    }

    async function inviteUser(invitedId) {
        try {
            if (invitedId === undefined || invitedId === null) {
                alert('초대할 사용자 ID가 유효하지 않습니다.');
                return;
            }

            const csrf = await getCsrfToken();
            const formData = new URLSearchParams();
            formData.append("inviterId", userId);
            formData.append("eventId", eventId);
            formData.append("invitedIds", invitedId); // Spring will parse this as a List element
            formData.append("_csrf", csrf);

            const res = await fetch("/api/events/invite", {
                method: "POST",
                headers: {"Content-Type": "application/x-www-form-urlencoded"},
                body: formData
            });

            const result = await res.json();
            if (result.result === "success") {
                alert("초대되었습니다.");
                closeInviteModal();
                await renderEvent();
            } else {
                alert("초대 실패: " + JSON.stringify(result));
            }
        } catch (error) {
            console.error('Error inviting user:', error);
            alert('사용자 초대 중 오류가 발생했습니다.');
        }
    }

    // 이벤트 수정 모달 이벤트 리스너 등록
    document.getElementById("editPrevMonth").addEventListener("click", () => {
        editCurrentMonth--;
        if (editCurrentMonth < 1) {
            editCurrentMonth = 12;
            editCurrentYear--;
        }
        generateEditCalendar(editCurrentYear, editCurrentMonth);
    });

    document.getElementById("editNextMonth").addEventListener("click", () => {
        editCurrentMonth++;
        if (editCurrentMonth > 12) {
            editCurrentMonth = 1;
            editCurrentYear++;
        }
        generateEditCalendar(editCurrentYear, editCurrentMonth);
    });

    document.getElementById("saveEventBtn").addEventListener("click", saveEditEvent);

    renderEvent();
</script>
</body>
</html>
