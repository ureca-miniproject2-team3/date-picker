<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Event 스케줄 등록</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .time-cell {
            height: 40px;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            padding-left: 1rem;
            display: flex;
            align-items: center;
        }
        .time-cell.selected {
            background-color: #a5a1e4;
            color: white;
        }
        .date-disabled {
            color: red !important;
            pointer-events: none;
        }
        .selected-date {
            background-color: #7c6dfa;
            color: white;
            border-radius: 9999px;
        }
    </style>
</head>
<body class="min-h-screen bg-[#f8f1e7] p-10 text-gray-800">
<div class="max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold mb-6">Event 스케줄 등록</h1>

    <div class="bg-white p-6 rounded-2xl shadow space-y-4">
        <div class="mb-4">
            <label class="block font-medium mb-2">날짜 선택</label>
            <div class="bg-[#fcf8f3] rounded-2xl p-4 shadow-sm">
                <div class="flex justify-between items-center mb-4">
                    <button id="prevMonth" type="button">&#9664;</button>
                    <div id="calendar-title" class="font-semibold"></div>
                    <button id="nextMonth" type="button">&#9654;</button>
                </div>
                <div class="grid grid-cols-7 text-center text-sm font-medium text-gray-500 mb-2">
                    <div class="text-red-400">일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div class="text-blue-400">토</div>
                </div>
                <div id="calendar" class="grid grid-cols-7 gap-1 text-center text-gray-700"></div>
            </div>
            <input type="hidden" id="selectedDate" name="date" />
        </div>

        <div class="mb-4">
            <label class="block font-medium mb-1">시간 선택 (드래그)</label>
            <div id="timeGrid" class="border rounded h-[300px] overflow-y-scroll bg-gray-50 text-sm"></div>
            <input type="hidden" id="dragStart" name="startTime" />
            <input type="hidden" id="dragEnd" name="endTime" />
        </div>

        <button id="saveBtn" class="bg-[#7c6dfa] text-white px-4 py-2 rounded hover:bg-[#6b5de6] transition w-full">
            스케줄 저장
        </button>
    </div>
</div>

<script>
    const selectedDateInput = document.getElementById("selectedDate");
    const calendar = document.getElementById("calendar");
    const today = new Date();
    let currentYear = today.getFullYear();
    let currentMonth = today.getMonth() + 1;
    let validDates = [];

    const urlParams = new URLSearchParams(location.search);
    const eventId = urlParams.get("eventId"); // ✅ eventId 정확히 가져오기

    if (!eventId) {
        alert("잘못된 접근입니다. eventId가 없습니다.");
        throw new Error("eventId가 없습니다.");
    }

    async function fetchEventDates(eventId) {
        const res = await fetch(`/api/events/${eventId}`);
        if (!res.ok) throw new Error(`이벤트 정보 로드 실패: ${res.status}`);
        const { eventDto } = await res.json();
        return Array.isArray(eventDto?.eventDates) ? eventDto.eventDates : [];
    }

    const generateCalendar = (year, month) => {
        calendar.innerHTML = "";
        document.getElementById("calendar-title").textContent = `${year}.${String(month).padStart(2, "0")}`;

        const firstDay = new Date(year, month - 1, 1);
        const lastDay = new Date(year, month, 0);
        const startDay = firstDay.getDay();
        const totalDays = lastDay.getDate();

        for (let i = 0; i < startDay; i++) calendar.appendChild(document.createElement("div"));

        for (let d = 1; d <= totalDays; d++) {
            const dateStr = `${year}-${String(month).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
            const btn = document.createElement("button");
            btn.textContent = d;
            btn.className = "py-1 hover:bg-[#e5dbff] transition";
            btn.dataset.date = dateStr;

            if (!validDates.includes(dateStr)) {
                btn.classList.add("date-disabled");
            } else {
                btn.addEventListener("click", () => {
                    document.querySelectorAll("#calendar button").forEach(el => el.classList.remove("selected-date"));
                    btn.classList.add("selected-date");
                    selectedDateInput.value = dateStr;
                });
            }

            calendar.appendChild(btn);
        }
    };

    document.getElementById("prevMonth").addEventListener("click", () => {
        currentMonth--;
        if (currentMonth < 1) {
            currentMonth = 12;
            currentYear--;
        }
        generateCalendar(currentYear, currentMonth);
    });

    document.getElementById("nextMonth").addEventListener("click", () => {
        currentMonth++;
        if (currentMonth > 12) {
            currentMonth = 1;
            currentYear++;
        }
        generateCalendar(currentYear, currentMonth);
    });

    // 시간 셀 구성
    const timeGrid = document.getElementById("timeGrid");
    const times = [];
    for (let h = 0; h < 24; h++) {
        times.push(`${String(h).padStart(2, "0")}:00`);
        times.push(`${String(h).padStart(2, "0")}:30`);
    }
    times.forEach(t => {
        const div = document.createElement("div");
        div.className = "time-cell";
        div.dataset.time = t;
        div.textContent = t;
        timeGrid.appendChild(div);
    });

    let isDragging = false;
    let startCell = null;

    timeGrid.addEventListener("mousedown", e => {
        if (!e.target.classList.contains("time-cell")) return;
        isDragging = true;
        startCell = e.target;
        document.querySelectorAll(".time-cell").forEach(c => c.classList.remove("selected"));
        startCell.classList.add("selected");
    });

    timeGrid.addEventListener("mousemove", e => {
        if (!isDragging || !e.target.classList.contains("time-cell")) return;
        const cells = [...document.querySelectorAll(".time-cell")];
        const startIdx = cells.indexOf(startCell);
        const curIdx = cells.indexOf(e.target);
        const [from, to] = [startIdx, curIdx].sort((a, b) => a - b);
        cells.forEach((c, i) => {
            c.classList.toggle("selected", i >= from && i <= to);
        });
    });

    document.addEventListener("mouseup", () => {
        if (isDragging) {
            isDragging = false;
            const selected = document.querySelectorAll(".time-cell.selected");
            if (selected.length) {
                document.getElementById("dragStart").value = selected[0].dataset.time;
                document.getElementById("dragEnd").value = selected[selected.length - 1].dataset.time;
            }
        }
    });

    document.getElementById("saveBtn").addEventListener("click", () => {
        const date = selectedDateInput.value;
        const start = document.getElementById("dragStart").value;
        const end = document.getElementById("dragEnd").value;
        if (!date || !start || !end) {
            alert("날짜 및 시간을 모두 선택해주세요.");
        } else {
            alert(`저장할 날짜: ${date}, 시간: ${start} ~ ${end}`);
        }
    });

    // ✨ 핵심: 이벤트 날짜 불러오고 캘린더 생성
    fetchEventDates(eventId)
        .then(dates => {
            validDates = dates;
            generateCalendar(currentYear, currentMonth);
        })
        .catch(err => {
            alert("이벤트 날짜 정보를 불러오지 못했습니다.");
            console.error(err);
        });
</script>
</body>
</html>
