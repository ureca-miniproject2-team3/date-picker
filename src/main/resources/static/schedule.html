<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Event 스케줄 등록</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .time-cell {
      height: 40px;
      border-bottom: 1px solid #e2e8f0;
      cursor: pointer;
      padding-left: 1rem;
      display: flex;
      align-items: center;
    }
    .time-cell.selected {
      background-color: #a5a1e4;
      color: white;
    }
  </style>
</head>
<body class="min-h-screen bg-[#f8f1e7] p-10 text-gray-800">
  <div class="max-w-6xl mx-auto space-y-10">
    <h1 class="text-3xl font-bold">Event 스케줄 등록</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      <!-- 좌측: 시간표 드래그 선택 -->
      <div class="bg-white p-6 rounded-2xl shadow space-y-4">
        <h2 class="text-xl font-semibold">시간표 드래그 선택</h2>
        <form id="form-drag" class="space-y-4">
          <div>
            <label for="datePicker" class="block font-medium mb-1">날짜 선택</label>
            <input type="date" id="datePicker" class="w-full border rounded px-3 py-2" required name="date">
          </div>

          <div id="timeGrid" class="border rounded h-[600px] overflow-y-scroll bg-gray-50 text-sm"></div>

          <input type="hidden" name="startTime" id="dragStart">
          <input type="hidden" name="endTime" id="dragEnd">

          <div class="pt-4">
            <button type="submit" class="bg-[#7c6dfa] text-white px-4 py-2 rounded hover:bg-[#6b5de6] transition">
              스케줄 저장
            </button>
          </div>
        </form>
      </div>

      <!-- 우측: 시간 직접 선택 -->
      <div class="bg-white p-6 rounded-2xl shadow space-y-4">
        <h2 class="text-xl font-semibold">시간 직접 선택</h2>
        <form id="form-direct" class="space-y-4">
          <div>
            <label for="date" class="block font-medium mb-1">날짜</label>
            <input type="date" id="date" name="date" required class="w-full border rounded px-3 py-2" />
          </div>

          <div>
            <label for="startTime" class="block font-medium mb-1">시작 시간</label>
            <select id="startTime" name="startTime" class="w-full border rounded px-3 py-2"></select>
          </div>

          <div>
            <label for="endTime" class="block font-medium mb-1">종료 시간</label>
            <select id="endTime" name="endTime" class="w-full border rounded px-3 py-2"></select>
          </div>

          <div class="pt-4">
            <button type="submit" class="bg-[#7c6dfa] text-white px-4 py-2 rounded hover:bg-[#6b5de6] transition">
              스케줄 저장
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <<script>
  const eventId = new URLSearchParams(location.search).get("eventId");
  const userId = sessionStorage.getItem("userId");

  if (!userId) {
    alert("로그인이 필요합니다.");
    location.href = "/login.html";
  }

  const grid = document.getElementById("timeGrid");
  const startTimeSelect = document.getElementById("startTime");
  const endTimeSelect = document.getElementById("endTime");

  const times = [];
  for (let h = 0; h < 24; h++) {
    times.push(`${h.toString().padStart(2, '0')}:00`);
    times.push(`${h.toString().padStart(2, '0')}:30`);
  }

  times.forEach(t => {
    const div = document.createElement("div");
    div.className = "time-cell";
    div.dataset.time = t;
    div.textContent = t;
    grid.appendChild(div);

    const opt1 = new Option(t, t);
    const opt2 = new Option(t, t);
    startTimeSelect.appendChild(opt1);
    endTimeSelect.appendChild(opt2);
  });

  const cells = document.querySelectorAll(".time-cell");
  let isDragging = false;
  let startCell = null;

  cells.forEach(cell => {
    cell.addEventListener("mousedown", () => {
      isDragging = true;
      startCell = cell;
      cells.forEach(c => c.classList.remove("selected"));
      cell.classList.add("selected");
    });

    cell.addEventListener("mouseenter", () => {
      if (isDragging && startCell) {
        let startIndex = [...cells].indexOf(startCell);
        let currentIndex = [...cells].indexOf(cell);

        cells.forEach(c => c.classList.remove("selected"));

        let [from, to] = [startIndex, currentIndex].sort((a, b) => a - b);
        for (let i = from; i <= to; i++) {
          cells[i].classList.add("selected");
        }
      }
    });
  });

  document.addEventListener("mouseup", () => {
    if (isDragging && startCell) {
      isDragging = false;
      const selected = document.querySelectorAll(".time-cell.selected");
      if (selected.length > 0) {
        const start = selected[0].dataset.time;
        const end = selected[selected.length - 1].dataset.time;
        const date = document.getElementById("datePicker").value;
        document.getElementById("dragStart").value = start;
        document.getElementById("dragEnd").value = end;
      }
    }
  });

  async function getCsrfToken() {
    const res = await fetch('/api/auth/csrf-token', { credentials: 'same-origin' });
    const data = await res.json();
    return data.token;
  }

  async function submitSchedule(data) {
    try {
      const csrf = await getCsrfToken();

      const res = await fetch("/api/schedules", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: new URLSearchParams({
          userId,
          eventId,
          startTime: data.startTime,
          endTime: data.endTime,
          _csrf: csrf
        })
      });

      const result = await res.json();
      if (result.result === "success") {
        alert("스케줄이 저장되었습니다.");
        location.href = `/event.html?id=${eventId}`;
      } else {
        alert("실패: " + JSON.stringify(result));
      }
    } catch (err) {
      alert("서버 오류 발생");
      console.error(err);
    }
  }

  function formatTime(date, time) {
    return `${date}T${time}:00`;
  }

  document.getElementById("form-drag").addEventListener("submit", function (e) {
    e.preventDefault();
    const date = document.getElementById("datePicker").value;
    const start = document.getElementById("dragStart").value;
    const end = document.getElementById("dragEnd").value;
    if (!start || !end) return alert("시간을 선택해주세요.");
    submitSchedule({
      startTime: formatTime(date, start),
      endTime: formatTime(date, end)
    });
  });

  document.getElementById("form-direct").addEventListener("submit", function (e) {
    e.preventDefault();
    const date = document.getElementById("date").value;
    const start = document.getElementById("startTime").value;
    const end = document.getElementById("endTime").value;
    if (!start || !end) return alert("시간을 선택해주세요.");
    submitSchedule({
      startTime: formatTime(date, start),
      endTime: formatTime(date, end)
    });
  });

  startTimeSelect.addEventListener("change", updateGridFromDropdowns);
  endTimeSelect.addEventListener("change", updateGridFromDropdowns);
  document.getElementById("date").addEventListener("change", updateGridFromDropdowns);

  function updateGridFromDropdowns() {
    const startVal = startTimeSelect.value;
    const endVal = endTimeSelect.value;
    const startIdx = [...cells].findIndex(c => c.dataset.time === startVal);
    const endIdx = [...cells].findIndex(c => c.dataset.time === endVal);

    if (startIdx >= 0 && endIdx >= 0) {
      cells.forEach(c => c.classList.remove("selected"));
      const [from, to] = [startIdx, endIdx].sort((a, b) => a - b);
      for (let i = from; i <= to; i++) {
        cells[i].classList.add("selected");
      }
    }
  }
</script>

</body>
</html>
