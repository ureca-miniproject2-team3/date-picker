<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Event 스케줄 등록</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .time-cell {
      height: 40px;
      border-bottom: 1px solid #e2e8f0;
      cursor: pointer;
      padding-left: 1rem;
      display: flex;
      align-items: center;
    }
    .time-cell.selected {
      background-color: #a5a1e4;
      color: white;
    }
  </style>
</head>
<body class="min-h-screen bg-[#f8f1e7] p-10 text-gray-800">
  <div class="max-w-6xl mx-auto space-y-10">
    <h1 class="text-3xl font-bold">Event 스케줄 등록</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      <!-- 좌측: 시간표 드래그 선택 -->
      <div class="bg-white p-6 rounded-2xl shadow space-y-4">
        <h2 class="text-xl font-semibold">시간표 드래그 선택</h2>
        <form action="/schedule/save" method="post" class="space-y-4">
          <input type="hidden" name="eventId" value="{{eventId}}">
          <input type="hidden" id="dragDate" name="date">
          <input type="hidden" id="dragStart" name="startTime">
          <input type="hidden" id="dragEnd" name="endTime">

          <div>
            <label for="datePicker" class="block font-medium mb-1">날짜 선택</label>
            <input type="date" id="datePicker" class="w-full border rounded px-3 py-2" required>
          </div>

          <div id="timeGrid" class="border rounded h-[600px] overflow-y-scroll bg-gray-50 text-sm"></div>

          <div class="pt-4">
            <button type="submit" class="bg-[#7c6dfa] text-white px-4 py-2 rounded hover:bg-[#6b5de6] transition">
              스케줄 저장
            </button>
          </div>
        </form>
      </div>

      <!-- 우측: 시간 직접 선택 -->
      <div class="bg-white p-6 rounded-2xl shadow space-y-4">
        <h2 class="text-xl font-semibold">시간 직접 선택</h2>
        <form action="/schedule/save" method="post" class="space-y-4">
          <input type="hidden" name="eventId" value="{{eventId}}" />

          <div>
            <label for="date" class="block font-medium mb-1">날짜</label>
            <input type="date" id="date" name="date" required class="w-full border rounded px-3 py-2" />
          </div>

          <div>
            <label for="startTime" class="block font-medium mb-1">시작 시간</label>
            <select id="startTime" name="startTime" class="w-full border rounded px-3 py-2"></select>
          </div>

          <div>
            <label for="endTime" class="block font-medium mb-1">종료 시간</label>
            <select id="endTime" name="endTime" class="w-full border rounded px-3 py-2"></select>
          </div>

          <div class="pt-4">
            <button type="submit" class="bg-[#7c6dfa] text-white px-4 py-2 rounded hover:bg-[#6b5de6] transition">
              스케줄 저장
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    const grid = document.getElementById("timeGrid");
    const startTimeSelect = document.getElementById("startTime");
    const endTimeSelect = document.getElementById("endTime");

    const times = [];
    for (let h = 0; h < 24; h++) {
      times.push(`${h.toString().padStart(2, '0')}:00`);
      times.push(`${h.toString().padStart(2, '0')}:30`);
    }

    times.forEach(t => {
      const div = document.createElement("div");
      div.className = "time-cell";
      div.dataset.time = t;
      div.textContent = t;
      grid.appendChild(div);

      const opt1 = document.createElement("option");
      opt1.value = t;
      opt1.textContent = t;
      startTimeSelect.appendChild(opt1);

      const opt2 = document.createElement("option");
      opt2.value = t;
      opt2.textContent = t;
      endTimeSelect.appendChild(opt2);
    });

    const cells = document.querySelectorAll(".time-cell");
    let isDragging = false;
    let startCell = null;

    function updateDropdowns(start, end, date) {
      startTimeSelect.value = start;
      endTimeSelect.value = end;
      document.getElementById("date").value = date;
    }

    function updateGridFromDropdowns() {
      const startVal = startTimeSelect.value;
      const endVal = endTimeSelect.value;
      const startIdx = Array.from(cells).findIndex(c => c.dataset.time === startVal);
      const endIdx = Array.from(cells).findIndex(c => c.dataset.time === endVal);

      if (startIdx >= 0 && endIdx >= 0) {
        cells.forEach(c => c.classList.remove("selected"));
        const [from, to] = [startIdx, endIdx].sort((a, b) => a - b);
        for (let i = from; i <= to; i++) {
          cells[i].classList.add("selected");
        }
        document.getElementById("dragStart").value = startVal;
        document.getElementById("dragEnd").value = endVal;
        document.getElementById("dragDate").value = document.getElementById("date").value;
        document.getElementById("datePicker").value = document.getElementById("date").value;
      }
    }

    cells.forEach(cell => {
      cell.addEventListener("mousedown", () => {
        isDragging = true;
        startCell = cell;
        cells.forEach(c => c.classList.remove("selected"));
        cell.classList.add("selected");
      });

      cell.addEventListener("mouseenter", () => {
        if (isDragging && startCell) {
          let startIndex = Array.from(cells).indexOf(startCell);
          let currentIndex = Array.from(cells).indexOf(cell);

          cells.forEach(c => c.classList.remove("selected"));

          let [from, to] = [startIndex, currentIndex].sort((a, b) => a - b);
          for (let i = from; i <= to; i++) {
            cells[i].classList.add("selected");
          }
        }
      });
    });

    document.addEventListener("mouseup", () => {
      if (isDragging && startCell) {
        isDragging = false;
        const selected = document.querySelectorAll(".time-cell.selected");
        if (selected.length > 0) {
          const start = selected[0].getAttribute("data-time");
          const end = selected[selected.length - 1].getAttribute("data-time");
          const date = document.getElementById("datePicker").value;
          document.getElementById("dragStart").value = start;
          document.getElementById("dragEnd").value = end;
          document.getElementById("dragDate").value = date;
          updateDropdowns(start, end, date);
        }
      }
    });

    startTimeSelect.addEventListener("change", updateGridFromDropdowns);
    endTimeSelect.addEventListener("change", updateGridFromDropdowns);
    document.getElementById("date").addEventListener("change", updateGridFromDropdowns);
  </script>
</body>
</html>
